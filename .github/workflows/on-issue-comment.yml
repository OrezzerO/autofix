name: On Issue Comment (with all history)

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  handle-comment:
    if: ${{ github.event.comment.body == '/autofix' }}
    runs-on: ubuntu-latest

    steps:
      - name: Show trigger info
        run: |
          echo "ðŸ”” Triggered by comment on issue #${{ github.event.issue.number }}"
          echo "ðŸ‘¤ Comment by: ${{ github.event.comment.user.login }}"
          echo "ðŸ’¬ Comment content:"
          echo "${{ github.event.comment.body }}"

      - name: Save Issue & Comment Info
        run: |
          cat <<'EOF' >> "$GITHUB_ENV"
ISSUE_NUMBER=${{ github.event.issue.number }}
ISSUE_TITLE=${{ github.event.issue.title }}
ISSUE_HTML_URL=${{ github.event.issue.html_url }}
ISSUE_BODY<<EOB
${{ github.event.issue.body }}
EOB
COMMENT_AUTHOR=${{ github.event.comment.user.login }}
COMMENT_BODY<<EOC
${{ github.event.comment.body }}
EOC
EOF

      - name: Get all comments for the issue
        id: get_comments
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
            });

            core.info(`Found ${comments.length} comments`);
            const formatted = comments
              .map(
                (c) => `ðŸ‘¤ ${c.user.login} @ ${c.created_at}\n${c.body}\n`,
              )
              .join('\n---\n');

            core.setOutput('all_comments', formatted);

      - name: Save comments to env
        run: |
          cat <<'EOF' >> "$GITHUB_ENV"
ALL_COMMENTS<<EOC
${{ steps.get_comments.outputs.all_comments }}
EOC
EOF

      - name: Show extracted info
        run: |
          echo "ðŸª¶ Issue #$ISSUE_NUMBER - $ISSUE_TITLE"
          echo ""
          echo "ðŸ“‹ Issue Body:"
          echo "$ISSUE_BODY"
          echo ""
          echo "ðŸ’¬ Latest Comment by $COMMENT_AUTHOR:"
          echo "$COMMENT_BODY"
          echo ""
          echo "ðŸ—ƒï¸ All Comments:"
          echo "$ALL_COMMENTS"

      - name: Check OpenAI API Key Set
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "OPENAI_API_KEY secret is not set. Skipping auto-fix." >&2
            exit 1
          fi

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm i; fi

      - name: Run Codex on Issue
        id: codex
        uses: openai/codex-action@main
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are responding to GitHub issue #${{ env.ISSUE_NUMBER }} titled "${{ env.ISSUE_TITLE }}".
            Issue URL: ${{ env.ISSUE_HTML_URL }}

            Issue body:
            ---
            ${{ env.ISSUE_BODY }}
            ---

            Latest comment from @${{ env.COMMENT_AUTHOR }} (trigger command):
            ---
            ${{ env.COMMENT_BODY }}
            ---

            Complete comment history:
            ---
            ${{ env.ALL_COMMENTS }}
            ---

            Make the minimal changes necessary to resolve this issue.
            Run relevant tests (npm test) before finishing, keep diffs focused, and ensure lint/test status is clean.
          codex_args: '["--config","sandbox_mode=\"workspace-write\""]'

      - name: Verify tests
        run: npm test --silent

      - name: Create pull request with fixes
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "fix(issue #${{ env.ISSUE_NUMBER }}): auto-fix via Codex"
          branch: codex/issue-${{ env.ISSUE_NUMBER }}-${{ github.run_id }}
          base: ${{ github.event.repository.default_branch }}
          title: "Auto-fix issue #${{ env.ISSUE_NUMBER }} via Codex"
          body: |
            This PR was generated by Codex in response to [issue #${{ env.ISSUE_NUMBER }}](${{ env.ISSUE_HTML_URL }}).

            Trigger: comment by @${{ env.COMMENT_AUTHOR }}:
            > ${{ env.COMMENT_BODY }}

            Issue body:
            ---
            ${{ env.ISSUE_BODY }}
            ---

            Please review the automated changes to ensure they fully resolve the issue.
